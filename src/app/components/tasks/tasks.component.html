<div class="tasks-container">
  <!-- Header -->
  <header class="tasks-header">
    <div class="header-left">
      <button class="icon-btn menu-btn" aria-label="Menú" (click)="toggleSidebar()" [class.active]="sidebarVisible">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <rect class="hamburger-line line-1" x="3" y="5" width="18" height="2" rx="1"></rect>
          <rect class="hamburger-line line-2" x="3" y="11" width="18" height="2" rx="1"></rect>
          <rect class="hamburger-line line-3" x="3" y="17" width="18" height="2" rx="1"></rect>
        </svg>
      </button>
      <div class="header-title">
        <div class="calendar-icon">
          <span class="calendar-day">{{ currentDay }}</span>
          <span class="calendar-month">{{ currentMonth }}</span>
        </div>
        <span>KodeoTask</span>
      </div>
    </div>
    <div class="header-right">
      <button class="icon-btn" [class.active]="viewMode === 'list'" aria-label="Vista lista" (click)="viewMode = 'list'" title="Vista lista">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
        </svg>
      </button>
      <button class="icon-btn" [class.active]="viewMode === 'columns'" aria-label="Vista columnas" (click)="viewMode = 'columns'" title="Vista columnas">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M4 6h4v12H4V6zm6 0h4v12h-4V6zm6 0h4v12h-4V6z"/>
        </svg>
      </button>
      
      <!-- Notificaciones -->
      <div class="notifications-container">
        <button class="icon-btn notifications-btn" (click)="toggleNotifications($event)" aria-label="Notificaciones" title="Notificaciones">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
          </svg>
          <span class="notification-badge" *ngIf="unreadCount > 0">{{ unreadCount > 99 ? '99+' : unreadCount }}</span>
        </button>
        <div *ngIf="showNotifications" class="notifications-dropdown">
          <div class="notifications-header">
            <h3>Notificaciones</h3>
            <button class="icon-btn-small" (click)="markAllAsRead()" *ngIf="unreadCount > 0" title="Marcar todas como leídas">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
              </svg>
            </button>
          </div>
          <div class="notifications-list">
            <div *ngIf="notifications.length === 0" class="no-notifications">
              <p>No hay notificaciones</p>
            </div>
            <div *ngFor="let notification of notifications" 
                 class="notification-item" 
                 [class.unread]="!notification.read"
                 (click)="openTaskFromNotification(notification.task)">
              <div class="notification-content">
                <div class="notification-title">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                  <strong>{{ notification.task.title }}</strong>
                </div>
                <div class="notification-message" *ngIf="notification.task.createdByUsername">
                  Asignada por <strong>{{ notification.task.createdByUsername }}</strong>
                </div>
                <div class="notification-time">
                  {{ formatNotificationTime(notification.timestamp) }}
                </div>
              </div>
              <button class="notification-close" (click)="clearNotification(notification.id, $event)" title="Eliminar notificación">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="user-menu-container">
        <button class="user-avatar" (click)="toggleUserMenu($event)" aria-label="Menú de usuario">
          <span>{{ getInitials() }}</span>
        </button>
        <div *ngIf="showUserMenu" class="user-dropdown-menu">
          <div class="user-info">
            <div class="user-name">{{ getFullName() }}</div>
            <div class="user-email">{{ currentUser?.email || '' }}</div>
          </div>
          <button class="dropdown-item logout-item" (click)="logout()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
            </svg>
            <span>Cerrar sesión</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="tasks-layout">
    <!-- Sidebar -->
    <aside class="tasks-sidebar" [class.sidebar-hidden]="!sidebarVisible">
      <button class="btn-create" (click)="openCreateModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        <span>Nueva tarea</span>
      </button>

      <nav class="sidebar-nav">
        <div class="nav-item active">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
          <span>Todas las tareas</span>
        </div>
      </nav>

      <div class="lists-section">
        <div class="lists-header" (click)="listsSectionVisible = !listsSectionVisible">
          <span>Listas</span>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" [class.rotated]="!listsSectionVisible">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
        <div class="lists-content" [class.hidden]="!listsSectionVisible">
          <div *ngFor="let category of categories" class="list-item" 
               [class.active]="selectedCategory === category"
               (click)="toggleCategoryVisibilityOnClick(category, $event)">
            <input type="checkbox" 
                   [checked]="isCategoryVisible(category)"
                   (change)="toggleCategoryVisibility(category, $event)"
                   (click)="$event.stopPropagation()">
            <span>{{ category }}</span>
            <span class="task-count" *ngIf="getPendingTasks(category).length > 0">
              {{ getPendingTasks(category).length }}
            </span>
          </div>
        </div>
        <button class="btn-create-list" (click)="openCreateListModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
          </svg>
          <span>Crear lista</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="tasks-main">
      <div class="tasks-content" [class.columns-view]="viewMode === 'columns'">
        <div *ngFor="let category of getVisibleCategories()" class="category-card">
          <div class="card-header">
            <h2 class="category-title">{{ category }}</h2>
            <div class="menu-container">
              <button class="icon-btn menu-dots" aria-label="Menú" (click)="toggleCategoryMenu(category, $event)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
              </button>
              <div *ngIf="openMenuCategory === category" class="dropdown-menu">
                <button class="dropdown-item delete-item" (click)="deleteCategory(category)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                  <span>Eliminar lista</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Pending Tasks -->
          <div class="tasks-list">
            <div *ngFor="let task of getPendingTasks(category)" class="task-item">
              <label class="task-checkbox">
                <input 
                  type="checkbox" 
                  [checked]="task.status === TaskStatus.COMPLETED"
                  (change)="toggleTaskComplete(task)"
                  (click)="$event.stopPropagation()"
                />
                <span class="checkmark"></span>
              </label>
              <div class="task-content" (click)="openTaskDetailsModal(task)">
                <div class="task-header">
                  <span class="task-title" 
                        [class.completed]="task.status === TaskStatus.COMPLETED">
                    {{ task.title }}
                  </span>
                  <!-- Mostrar quién asignó la tarea (para usuarios asignados) -->
                  <span class="task-assigned-by" *ngIf="isTaskAssignedToMe(task) && task.createdByUsername">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Asignada por {{ task.createdByUsername }}
                  </span>
                  <!-- Mostrar a quién está asignada (para el creador) -->
                  <span class="task-assigned-to" *ngIf="isTaskCreatedByMe(task) && getAssignedUsersNamesForTask(task).length > 0">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Asignada a {{ getFirstAssignedUserName(task) }}
                  </span>
                </div>
                <span class="task-due-date" *ngIf="task.dueDate">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                  </svg>
                  {{ formatDate(task.dueDate) }}
                </span>
              </div>
            </div>
          </div>

          <!-- Completed Tasks Section -->
          <div *ngIf="getCompletedTasks(category).length > 0" class="completed-section">
            <button 
              class="completed-toggle" 
              (click)="toggleCompletedTasks(category)"
              [attr.aria-expanded]="showCompletedTasks[category]">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" 
                   [class.rotated]="showCompletedTasks[category]">
                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
              </svg>
              <span>Completadas ({{ getCompletedTasks(category).length }})</span>
            </button>
            <div *ngIf="showCompletedTasks[category]" class="completed-tasks">
              <div *ngFor="let task of getCompletedTasks(category)" class="task-item completed">
                <label class="task-checkbox">
                  <input 
                    type="checkbox" 
                    checked
                    (change)="toggleTaskComplete(task)"
                    (click)="$event.stopPropagation()"
                  />
                  <span class="checkmark"></span>
                </label>
                <span class="task-title completed" (click)="openTaskDetailsModal(task)">{{ task.title }}</span>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="categories.length === 0" class="empty-state">
          <p>No hay tareas para mostrar</p>
          <button class="btn btn-primary" (click)="openCreateModal()">Crear tu primera tarea</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal Crear Tarea -->
  <div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Nueva Tarea</h2>
      <form (ngSubmit)="createTask()">
        <div class="form-group">
          <label>Título *</label>
          <input [(ngModel)]="taskTitle" name="title" required placeholder="Título de la tarea" />
        </div>
        <div class="form-group">
          <label>Descripción</label>
          <textarea [(ngModel)]="taskDescription" name="description" rows="4" placeholder="Descripción de la tarea"></textarea>
        </div>
        <div class="form-group">
          <label>Categoría/Lista</label>
          <select [(ngModel)]="taskCategory" name="category" class="form-select">
            <option value="">Sin categoría</option>
            <option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Fecha de entrega *</label>
          <input type="date" [(ngModel)]="taskDueDate" name="dueDate" required />
        </div>
        <div class="form-group">
          <label>Asignar a usuarios</label>
          <div class="users-select-container">
            <div class="users-list">
              <label *ngFor="let user of availableUsers" class="user-checkbox-label">
                <input 
                  type="checkbox" 
                  [value]="user.id"
                  [checked]="isUserSelected(user.id)"
                  (change)="toggleUserSelection(user.id)"
                />
                <span>{{ getUserDisplayName(user) }}</span>
              </label>
            </div>
            <p *ngIf="availableUsers.length === 0" class="no-users-message">
              No hay usuarios disponibles
            </p>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" (click)="closeCreateModal()" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Editar Tarea -->
  <div *ngIf="showEditModal" class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Editar Tarea</h2>
      <form (ngSubmit)="updateTask()">
        <div class="form-group">
          <label>Título *</label>
          <input [(ngModel)]="taskTitle" name="title" required />
        </div>
        <div class="form-group">
          <label>Descripción</label>
          <textarea [(ngModel)]="taskDescription" name="description" rows="4"></textarea>
        </div>
        <div class="form-group">
          <label>Categoría/Lista</label>
          <select [(ngModel)]="taskCategory" name="category" class="form-select">
            <option value="">Sin categoría</option>
            <option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Fecha de vencimiento</label>
          <input type="date" [(ngModel)]="taskDueDate" name="dueDate" />
        </div>
        <div class="form-actions">
          <button type="button" (click)="closeCreateModal()" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Crear Lista -->
  <div *ngIf="showCreateListModal" class="modal-overlay" (click)="closeCreateListModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Crear Lista</h2>
      <form (ngSubmit)="createList()">
        <div class="form-group">
          <label>Nombre de la lista *</label>
          <input 
            [(ngModel)]="listName" 
            name="listName" 
            required 
            placeholder="Ej: Trabajo, Personal, Compras..." 
            autofocus
          />
        </div>
        <div class="form-actions">
          <button type="button" (click)="closeCreateListModal()" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Detalles de Tarea -->
  <div *ngIf="showTaskDetailsModal && selectedTask" class="modal-overlay" (click)="closeTaskDetailsModal()">
    <div class="modal-content task-details-modal" (click)="$event.stopPropagation()">
      <div class="task-details-header">
        <h2 *ngIf="!isEditingInDetails || !isTaskOwner()">{{ selectedTask.title }}</h2>
        <input 
          *ngIf="isEditingInDetails && isTaskOwner()"
          type="text"
          [(ngModel)]="taskTitle"
          class="task-title-input"
          placeholder="Título de la tarea"
        />
        <button class="icon-btn close-btn" (click)="closeTaskDetailsModal()" aria-label="Cerrar">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>

      <div class="task-details-content">
        <div class="detail-section">
          <label class="detail-label">Estado</label>
          <div class="detail-value">
            <span [class]="'status-badge ' + getStatusClass(selectedTask.status)">
              {{ getStatusLabel(selectedTask.status) }}
            </span>
          </div>
        </div>

        <div class="detail-section">
          <label class="detail-label">Descripción</label>
          <div *ngIf="!isEditingInDetails || !isTaskOwner()" class="detail-value description-text">
            {{ selectedTask.description || 'Sin descripción' }}
          </div>
          <textarea 
            *ngIf="isEditingInDetails && isTaskOwner()"
            [(ngModel)]="taskDescription"
            class="task-description-input"
            rows="4"
            placeholder="Descripción de la tarea"
          ></textarea>
        </div>

        <div class="detail-section" *ngIf="isTaskAssignedToMe(selectedTask) && selectedTask.createdByUsername">
          <label class="detail-label">Asignada por</label>
          <div class="detail-value">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 4px;">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            {{ selectedTask.createdByUsername }}
          </div>
        </div>

        <div class="detail-section">
          <label class="detail-label">Asignada a</label>
          <div *ngIf="!isEditingInDetails || !isTaskOwner()" class="detail-value">
            <div *ngIf="getAssignedUsersNames().length > 0" class="assigned-users-list">
              <span *ngFor="let userName of getAssignedUsersNames(); let last = last" class="assigned-user-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 4px;">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                {{ userName }}
              </span>
            </div>
            <span *ngIf="getAssignedUsersNames().length === 0" class="no-assigned-users">
              Sin asignar
            </span>
          </div>
          <div *ngIf="isEditingInDetails && isTaskOwner()" class="users-select-container">
            <div class="users-list">
              <label *ngFor="let user of availableUsers" class="user-checkbox-label">
                <input 
                  type="checkbox" 
                  [value]="user.id"
                  [checked]="isUserSelectedInDetails(user.id)"
                  (change)="toggleUserSelectionInDetails(user.id)"
                />
                <span>{{ getUserDisplayName(user) }}</span>
              </label>
            </div>
            <p *ngIf="availableUsers.length === 0" class="no-users-message">
              No hay usuarios disponibles
            </p>
          </div>
        </div>

        <div class="detail-section">
          <label class="detail-label">Categoría/Lista</label>
          <div *ngIf="!isEditingInDetails || !isTaskOwner()" class="detail-value">
            {{ selectedTask.category || 'Sin categoría' }}
          </div>
          <select 
            *ngIf="isEditingInDetails && isTaskOwner()"
            [(ngModel)]="taskCategory"
            class="task-category-select"
          >
            <option value="">Sin categoría</option>
            <option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>

        <div class="detail-section">
          <label class="detail-label">Fecha de vencimiento</label>
          <div *ngIf="!isEditingInDetails || !isTaskOwner()" class="detail-value">
            <svg *ngIf="selectedTask.dueDate" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
              <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
            </svg>
            {{ selectedTask.dueDate ? formatDate(selectedTask.dueDate) : 'Sin fecha de vencimiento' }}
          </div>
          <input 
            *ngIf="isEditingInDetails && isTaskOwner()"
            type="date"
            [(ngModel)]="taskDueDate"
            class="task-due-date-input"
          />
        </div>

        <div class="detail-section" *ngIf="selectedTask.createdAt">
          <label class="detail-label">Fecha de creación</label>
          <div class="detail-value">
            {{ formatDateTime(selectedTask.createdAt) }}
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedTask.updatedAt && selectedTask.updatedAt !== selectedTask.createdAt">
          <label class="detail-label">Última actualización</label>
          <div class="detail-value">
            {{ formatDateTime(selectedTask.updatedAt) }}
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedTask.completedAt">
          <label class="detail-label">Fecha de completado</label>
          <div class="detail-value">
            {{ formatDateTime(selectedTask.completedAt) }}
          </div>
        </div>
      </div>

      <div class="task-details-actions">
        <button 
          *ngIf="isTaskOwner()"
          type="button" 
          (click)="deleteTask(selectedTask); closeTaskDetailsModal()" 
          class="btn btn-delete delete-btn-left">
          Eliminar
        </button>
        <div class="actions-right">
          <button 
            type="button" 
            (click)="isEditingInDetails ? cancelEditInDetails() : closeTaskDetailsModal()" 
            class="btn btn-secondary">
            {{ isEditingInDetails ? 'Cancelar' : 'Cerrar' }}
          </button>
          <button 
            *ngIf="isTaskOwner()"
            type="button" 
            (click)="toggleEditInDetails()" 
            class="btn btn-primary">
            {{ isEditingInDetails ? 'Guardar' : 'Editar' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
