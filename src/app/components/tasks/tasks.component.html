<div class="tasks-container">
  <!-- Header -->
  <header class="tasks-header">
    <div class="header-left">
      <button class="icon-btn menu-btn" aria-label="Menú" (click)="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
      </button>
      <div class="header-title">
        <div class="calendar-icon">21</div>
        <span>TaskCore</span>
      </div>
    </div>
    <div class="header-right">
      <button class="icon-btn" aria-label="Ayuda">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
        </svg>
      </button>
      <button class="icon-btn active" aria-label="Tareas">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
        </svg>
      </button>
      <button class="icon-btn" aria-label="Apps">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/>
        </svg>
      </button>
      <div class="user-avatar">
        <span>{{ currentUser?.username?.charAt(0).toUpperCase() || 'U' }}</span>
      </div>
    </div>
  </header>

  <div class="tasks-layout">
    <!-- Sidebar -->
    <aside class="tasks-sidebar" [class.sidebar-hidden]="!sidebarVisible">
      <button class="btn-create" (click)="openCreateModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        <span>Crear</span>
      </button>

      <nav class="sidebar-nav">
        <div class="nav-item active">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
          <span>Todas las tareas</span>
        </div>
      </nav>

      <div class="lists-section">
        <div class="lists-header">
          <span>Listas</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 10l5 5 5-5z"/>
          </svg>
        </div>
        <div class="lists-content">
          <div *ngFor="let category of categories" class="list-item" 
               [class.active]="selectedCategory === category"
               (click)="selectedCategory = category">
            <input type="checkbox" 
                   [checked]="isCategoryVisible(category)"
                   (change)="toggleCategoryVisibility(category, $event)"
                   (click)="$event.stopPropagation()">
            <span>{{ category }}</span>
            <span class="task-count" *ngIf="getPendingTasks(category).length > 0">
              {{ getPendingTasks(category).length }}
            </span>
          </div>
        </div>
        <button class="btn-create-list" (click)="openCreateListModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
          </svg>
          <span>Crear lista</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="tasks-main">
      <div class="tasks-content">
        <div *ngFor="let category of getVisibleCategories()" class="category-card">
          <div class="card-header">
            <h2 class="category-title">{{ category }}</h2>
            <button class="icon-btn menu-dots" aria-label="Menú">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
              </svg>
            </button>
          </div>

          <!-- Quick Add Task -->
          <div class="quick-add-task">
            <div class="task-checkbox-placeholder"></div>
            <input 
              type="text" 
              class="quick-add-input"
              placeholder="Agregar una tarea"
              [(ngModel)]="quickAddTitle[category]"
              (keyup.enter)="quickAddTask(category)"
            />
          </div>

          <!-- Pending Tasks -->
          <div class="tasks-list">
            <div *ngFor="let task of getPendingTasks(category)" class="task-item">
              <label class="task-checkbox">
                <input 
                  type="checkbox" 
                  [checked]="task.status === TaskStatus.COMPLETED"
                  (change)="toggleTaskComplete(task)"
                  (click)="$event.stopPropagation()"
                />
                <span class="checkmark"></span>
              </label>
              <span class="task-title" 
                    [class.completed]="task.status === TaskStatus.COMPLETED"
                    (click)="openTaskDetailsModal(task)">
                {{ task.title }}
              </span>
              <span class="task-due-date" *ngIf="task.dueDate" (click)="openTaskDetailsModal(task)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                {{ formatDate(task.dueDate) }}
              </span>
            </div>
          </div>

          <!-- Completed Tasks Section -->
          <div *ngIf="getCompletedTasks(category).length > 0" class="completed-section">
            <button 
              class="completed-toggle" 
              (click)="toggleCompletedTasks(category)"
              [attr.aria-expanded]="showCompletedTasks[category]">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" 
                   [class.rotated]="showCompletedTasks[category]">
                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
              </svg>
              <span>Completadas ({{ getCompletedTasks(category).length }})</span>
            </button>
            <div *ngIf="showCompletedTasks[category]" class="completed-tasks">
              <div *ngFor="let task of getCompletedTasks(category)" class="task-item completed">
                <label class="task-checkbox">
                  <input 
                    type="checkbox" 
                    checked
                    (change)="toggleTaskComplete(task)"
                    (click)="$event.stopPropagation()"
                  />
                  <span class="checkmark"></span>
                </label>
                <span class="task-title completed" (click)="openTaskDetailsModal(task)">{{ task.title }}</span>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="categories.length === 0" class="empty-state">
          <p>No hay tareas para mostrar</p>
          <button class="btn btn-primary" (click)="openCreateModal()">Crear tu primera tarea</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal Crear Tarea -->
  <div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Nueva Tarea</h2>
      <form (ngSubmit)="createTask()">
        <div class="form-group">
          <label>Título *</label>
          <input [(ngModel)]="taskTitle" name="title" required placeholder="Título de la tarea" />
        </div>
        <div class="form-group">
          <label>Descripción</label>
          <textarea [(ngModel)]="taskDescription" name="description" rows="4" placeholder="Descripción de la tarea"></textarea>
        </div>
        <div class="form-group">
          <label>Categoría/Lista</label>
          <select [(ngModel)]="taskCategory" name="category" class="form-select">
            <option value="">Sin categoría</option>
            <option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Fecha de vencimiento</label>
          <input type="date" [(ngModel)]="taskDueDate" name="dueDate" />
        </div>
        <div class="form-actions">
          <button type="button" (click)="closeCreateModal()" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Editar Tarea -->
  <div *ngIf="showEditModal" class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Editar Tarea</h2>
      <form (ngSubmit)="updateTask()">
        <div class="form-group">
          <label>Título *</label>
          <input [(ngModel)]="taskTitle" name="title" required />
        </div>
        <div class="form-group">
          <label>Descripción</label>
          <textarea [(ngModel)]="taskDescription" name="description" rows="4"></textarea>
        </div>
        <div class="form-group">
          <label>Categoría/Lista</label>
          <select [(ngModel)]="taskCategory" name="category" class="form-select">
            <option value="">Sin categoría</option>
            <option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Fecha de vencimiento</label>
          <input type="date" [(ngModel)]="taskDueDate" name="dueDate" />
        </div>
        <div class="form-actions">
          <button type="button" (click)="closeCreateModal()" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Crear Lista -->
  <div *ngIf="showCreateListModal" class="modal-overlay" (click)="closeCreateListModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Crear Lista</h2>
      <form (ngSubmit)="createList()">
        <div class="form-group">
          <label>Nombre de la lista *</label>
          <input 
            [(ngModel)]="listName" 
            name="listName" 
            required 
            placeholder="Ej: Trabajo, Personal, Compras..." 
            autofocus
          />
        </div>
        <div class="form-actions">
          <button type="button" (click)="closeCreateListModal()" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Detalles de Tarea -->
  <div *ngIf="showTaskDetailsModal && selectedTask" class="modal-overlay" (click)="closeTaskDetailsModal()">
    <div class="modal-content task-details-modal" (click)="$event.stopPropagation()">
      <div class="task-details-header">
        <h2 *ngIf="!isEditingInDetails || !isTaskOwner()">{{ selectedTask.title }}</h2>
        <input 
          *ngIf="isEditingInDetails && isTaskOwner()"
          type="text"
          [(ngModel)]="taskTitle"
          class="task-title-input"
          placeholder="Título de la tarea"
        />
        <button class="icon-btn close-btn" (click)="closeTaskDetailsModal()" aria-label="Cerrar">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>

      <div class="task-details-content">
        <div class="detail-section">
          <label class="detail-label">Estado</label>
          <div class="detail-value">
            <span [class]="'status-badge ' + getStatusClass(selectedTask.status)">
              {{ getStatusLabel(selectedTask.status) }}
            </span>
          </div>
        </div>

        <div class="detail-section">
          <label class="detail-label">Descripción</label>
          <div *ngIf="!isEditingInDetails || !isTaskOwner()" class="detail-value description-text">
            {{ selectedTask.description || 'Sin descripción' }}
          </div>
          <textarea 
            *ngIf="isEditingInDetails && isTaskOwner()"
            [(ngModel)]="taskDescription"
            class="task-description-input"
            rows="4"
            placeholder="Descripción de la tarea"
          ></textarea>
        </div>

        <div class="detail-section">
          <label class="detail-label">Categoría/Lista</label>
          <div *ngIf="!isEditingInDetails || !isTaskOwner()" class="detail-value">
            {{ selectedTask.category || 'Sin categoría' }}
          </div>
          <select 
            *ngIf="isEditingInDetails && isTaskOwner()"
            [(ngModel)]="taskCategory"
            class="task-category-select"
          >
            <option value="">Sin categoría</option>
            <option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>

        <div class="detail-section">
          <label class="detail-label">Fecha de vencimiento</label>
          <div *ngIf="!isEditingInDetails || !isTaskOwner()" class="detail-value">
            <svg *ngIf="selectedTask.dueDate" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
              <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
            </svg>
            {{ selectedTask.dueDate ? formatDate(selectedTask.dueDate) : 'Sin fecha de vencimiento' }}
          </div>
          <input 
            *ngIf="isEditingInDetails && isTaskOwner()"
            type="date"
            [(ngModel)]="taskDueDate"
            class="task-due-date-input"
          />
        </div>

        <div class="detail-section" *ngIf="selectedTask.createdAt">
          <label class="detail-label">Fecha de creación</label>
          <div class="detail-value">
            {{ formatDateTime(selectedTask.createdAt) }}
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedTask.updatedAt && selectedTask.updatedAt !== selectedTask.createdAt">
          <label class="detail-label">Última actualización</label>
          <div class="detail-value">
            {{ formatDateTime(selectedTask.updatedAt) }}
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedTask.completedAt">
          <label class="detail-label">Fecha de completado</label>
          <div class="detail-value">
            {{ formatDateTime(selectedTask.completedAt) }}
          </div>
        </div>
      </div>

      <div class="task-details-actions">
        <button 
          type="button" 
          (click)="isEditingInDetails ? cancelEditInDetails() : closeTaskDetailsModal()" 
          class="btn btn-secondary">
          {{ isEditingInDetails ? 'Cancelar' : 'Cerrar' }}
        </button>
        <button 
          *ngIf="isTaskOwner()"
          type="button" 
          (click)="toggleEditInDetails()" 
          class="btn btn-primary">
          {{ isEditingInDetails ? 'Guardar' : 'Editar' }}
        </button>
        <button 
          *ngIf="isTaskOwner()"
          type="button" 
          (click)="deleteTask(selectedTask); closeTaskDetailsModal()" 
          class="btn btn-delete">
          Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
